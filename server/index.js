const express = require("express");
const db = require("./models/index");
const cors = require("cors");
const ExcelJS = require("exceljs");
const bodyParser = require("body-parser");
const promBundle = require("express-prom-bundle");
const logger = require("./config/logger");

require("dotenv").config();

const API_TOKEN = process.env.API_TOKEN;
const PORT = process.env.PORT || 3001;
const app = express();

app.use(
  promBundle({
    includeMethod: true,
    includePath: true,
    includeStatusCode: true,
    includeUp: true,
    promClient: {
      collectDefaultMetrics: {},
    },
  })
);

app.use(
  cors({
    origin: ["http://localhost:3000", "https://parks.shicks255.com"],
  })
);

app.use(bodyParser.json());

db.sequelize.sync({ force: true }).then(() => {
  console.log("Dropping and re-syncing db.");

  const natParkSheet = new ExcelJS.Workbook();
  natParkSheet.xlsx.readFile("./natParks.xlsx").then((book) => {
    const sheet = book.worksheets[0];
    const rowCount = sheet.actualRowCount;
    for (let i = 2; i < rowCount; i++) {
      let row = sheet.getRow(i);
      const parkName = row.getCell(1);
      const code = row.getCell(2);
      const id = row.getCell(3);
      const type = row.getCell(4);
      const state1 = row.getCell(5);
      const state2 = row.getCell(6);
      const lat = row.getCell(7);
      const long = row.getCell(8);

      if (
        type.value &&
        type.value.length > 0 &&
        code.value &&
        code.value.length > 0
      ) {
        const newPark = {
          name: parkName.value,
          code: code.value,
          type: type.value,
          state: state1.value,
          latitude: lat.value,
          longitude: long.value,
        };
        if (parkName.value === "Arches National Park") {
          newPark.outline = [
            [38.84639268206846, -109.71324920654295],
            [38.83917278092989, -109.71256256103516],
            [38.83890536311489, -109.7043228149414],
            [38.83248703408408, -109.70294952392578],
            [38.831952147204525, -109.69505310058594],
            [38.82473078093276, -109.69505310058594],
            [38.82419583577267, -109.68544006347656],
            [38.802527179317885, -109.68509674072266],
            [38.802527179317885, -109.69436645507812],
            [38.77416070913117, -109.69505310058594],
            [38.77389304718155, -109.68544006347656],
            [38.759973241762665, -109.68509674072266],
            [38.7591700932071, -109.67170715332031],
            [38.745782953288945, -109.67239379882812],
            [38.74444410121548, -109.65385437011719],
            [38.73882064836625, -109.65351104736328],
            [38.738285058332586, -109.63497161865234],
            [38.687653678261704, -109.63497161865234],
            [38.687653678261704, -109.65316772460938],
            [38.66647967071403, -109.65385437011719],
            [38.66647967071403, -109.64424133300781],
            [38.64503125499879, -109.64389801025389],
            [38.64449496232183, -109.63977813720703],
            [38.634036452919226, -109.64012145996094],
            [38.633768265944475, -109.63462829589844],
            [38.618479949960594, -109.63428497314453],
            [38.61391964574221, -109.62329864501953],
            [38.61633396056061, -109.6160888671875],
            [38.60587134283919, -109.59857940673828],
            [38.60748107564479, -109.58175659179686],
            [38.60882249206389, -109.58072662353514],
            [38.608554210786295, -109.56562042236327],
            [38.60452987124928, -109.56459045410156],
            [38.6053347572125, -109.5611572265625],
            [38.61391964574221, -109.55875396728516],
            [38.614456167168505, -109.55463409423828],
            [38.61257832462118, -109.54982757568358],
            [38.60962732987789, -109.54399108886719],
            [38.6241128666586, -109.5172119140625],
            [38.63189092902837, -109.49764251708984],
            [38.633768265944475, -109.4900894165039],
            [38.63859547797984, -109.48013305664061],
            [38.64369051578083, -109.47772979736328],
            [38.646371969131536, -109.478759765625],
            [38.64932145192219, -109.48356628417969],
            [38.64449496232183, -109.49901580810547],
            [38.64583568648869, -109.50553894042969],
            [38.65173457480478, -109.50691223144531],
            [38.66138625351512, -109.50244903564453],
            [38.69140538062125, -109.5003890991211],
            [38.69140538062125, -109.50519561767578],
            [38.699444080321705, -109.50553894042969],
            [38.699444080321705, -109.50965881347656],
            [38.71685816358206, -109.51000213623047],
            [38.717126039425644, -109.51377868652344],
            [38.72489400215132, -109.51412200927734],
            [38.725161847874716, -109.49043273925781],
            [38.739088441876866, -109.49077606201172],
            [38.73935623438332, -109.48150634765625],
            [38.76024095593923, -109.48253631591797],
            [38.761044092443086, -109.51000213623047],
            [38.768004230175954, -109.51000213623047],
            [38.767870387776135, -109.49764251708984],
            [38.77710492428489, -109.48270797729492],
            [38.77884463065734, -109.48305130004881],
            [38.7800490179011, -109.48184967041016],
            [38.79650693825768, -109.48219299316406],
            [38.79730966645052, -109.52733993530273],
            [38.79476766282312, -109.53386306762695],
            [38.79396490599955, -109.53746795654297],
            [38.79490145474802, -109.53798294067381],
            [38.79650693825768, -109.53557968139648],
            [38.79730966645052, -109.53386306762695],
            [38.79904887985135, -109.53300476074219],
            [38.80011914392429, -109.53077316284178],
            [38.7999853617942, -109.5285415649414],
            [38.802527179317885, -109.52733993530273],
            [38.802794733782875, -109.52974319458008],
            [38.80413249103831, -109.53077316284178],
            [38.802125845736676, -109.53231811523438],
            [38.801858288760066, -109.53386306762695],
            [38.80346361555011, -109.53575134277344],
            [38.8057377665913, -109.53712463378906],
            [38.80814561210589, -109.53763961791991],
            [38.809884561033435, -109.53712463378906],
            [38.81011864707045, -109.53656673431396],
            [38.81051993563, -109.5377254486084],
            [38.809918001942975, -109.53836917877197],
            [38.81035273233823, -109.53879833221436],
            [38.81118874487239, -109.53854084014893],
            [38.81118874487239, -109.54102993011475],
            [38.81092122192896, -109.54098701477051],
            [38.81055337624125, -109.54060077667235],
            [38.81018552865404, -109.54077243804932],
            [38.809683915246616, -109.54072952270508],
            [38.80881444363992, -109.5400857925415],
            [38.808580353317296, -109.53969955444336],
            [38.808279378915046, -109.54004287719727],
            [38.80777775208563, -109.5397424697876],
            [38.8060721944458, -109.54077243804932],
            [38.805804652287776, -109.54098701477051],
            [38.80513579249734, -109.54055786132812],
            [38.80389838533168, -109.54030036926268],
            [38.803196063596715, -109.5397424697876],
            [38.802527179317885, -109.54012870788574],
            [38.80225962384822, -109.54111576080322],
            [38.80118939192329, -109.54163074493407],
            [38.80048704348695, -109.5415449142456],
            [38.799784688128156, -109.54188823699951],
            [38.798112385601996, -109.54304695129395],
            [38.79821272486023, -109.54459190368651],
            [38.79821272486023, -109.54600811004639],
            [38.79854718803394, -109.54695224761963],
            [38.79971779678058, -109.54802513122559],
            [38.801323171792944, -109.54720973968504],
            [38.804032160115376, -109.54832553863525],
            [38.80510234934297, -109.54836845397949],
            [38.805838095112485, -109.54858303070068],
            [38.8074767742926, -109.54974174499512],
            [38.80928262197758, -109.54952716827391],
            [38.80985112010823, -109.54922676086426],
            [38.81001832457736, -109.55467700958252],
            [38.80674104544546, -109.55476284027098],
            [38.804600700144, -109.55373287200928],
            [38.80413249103831, -109.55467700958252],
            [38.80326295167924, -109.55433368682861],
            [38.803028843115676, -109.55321788787842],
            [38.80219273482385, -109.5536470413208],
            [38.801590730778805, -109.55132961273193],
            [38.800052252890644, -109.55167293548584],
            [38.79868097286392, -109.55141544342041],
            [38.79801204620252, -109.5521879196167],
            [38.79720932592086, -109.55248832702635],
            [38.7968748564684, -109.55446243286131],
            [38.79617246550887, -109.55592155456543],
            [38.79637314934652, -109.55866813659668],
            [38.795938333650746, -109.55896854400635],
            [38.796406596597855, -109.56321716308594],
            [38.79587143869288, -109.56308841705322],
            [38.79553696296169, -109.56253051757812],
            [38.79553696296169, -109.5799970626831],
            [38.81001832457736, -109.57995414733887],
            [38.81011864707045, -109.59849357604979],
            [38.81727462040405, -109.59853649139404],
            [38.81727462040405, -109.61707592010498],
            [38.82442987477478, -109.61703300476074],
            [38.82442987477478, -109.63540077209473],
            [38.83175156358844, -109.63552951812744],
            [38.83178499423038, -109.6669864654541],
            [38.84686061334277, -109.66681480407715],
            [38.84689403688745, -109.71320629119873],
          ];
        }
        if (parkName.value === "Bryce Canyon National Park") {
          newPark.outline = [
            [37.54376067569239, -112.27375030517578],
            [37.49338360812417, -112.27375030517578],
            [37.492838805363476, -112.2641372680664],
            [37.45033194775847, -112.26516723632812],
            [37.44978683111484, -112.26722717285156],
            [37.4426999532675, -112.26551055908203],
            [37.44242736763641, -112.23014831542969],
            [37.44951427130335, -112.23014831542969],
            [37.44951427130335, -112.22808837890625],
            [37.45714557062557, -112.22808837890625],
            [37.45714557062557, -112.21538543701172],
            [37.49256640249286, -112.21538543701172],
            [37.49392840691085, -112.24731445312499],
            [37.52225246712464, -112.24697113037108],
            [37.52225246712464, -112.23770141601562],
            [37.54457732085582, -112.23838806152344],
            [37.54484953392233, -112.2201919555664],
            [37.55192672475736, -112.2201919555664],
            [37.55219891098551, -112.21057891845703],
            [37.56635122499224, -112.21057891845703],
            [37.56662335853239, -112.1649169921875],
            [37.564990542378965, -112.1649169921875],
            [37.565262680889965, -112.12955474853516],
            [37.59682400108367, -112.12955474853516],
            [37.59723203397509, -112.13333129882812],
            [37.604440246103636, -112.13367462158203],
            [37.60471224043399, -112.12869644165039],
            [37.608112085649175, -112.12886810302734],
            [37.608112085649175, -112.13333129882812],
            [37.61559119810624, -112.13367462158203],
            [37.615455220956996, -112.11994171142578],
            [37.62266166720963, -112.12011337280273],
            [37.623069558373494, -112.11101531982422],
            [37.63353799897018, -112.11067199707031],
            [37.633673943045224, -112.10174560546875],
            [37.65175228874552, -112.10140228271484],
            [37.65202410998995, -112.09693908691406],
            [37.66289614387081, -112.09676742553711],
            [37.66289614387081, -112.08337783813477],
            [37.681103233738924, -112.0832061767578],
            [37.681239090750346, -112.08423614501952],
            [37.699170032110345, -112.08457946777344],
            [37.69903420794415, -112.11616516113281],
            [37.69523103025956, -112.11599349975586],
            [37.69550269227836, -112.13882446289061],
            [37.681103233738924, -112.13933944702148],
            [37.68083151896963, -112.14603424072264],
            [37.677570864111296, -112.14569091796874],
            [37.67743500038218, -112.14363098144531],
            [37.67485354225758, -112.14345932006836],
            [37.67471767355255, -112.13882446289061],
            [37.67213612088675, -112.13865280151367],
            [37.67200024720591, -112.1432876586914],
            [37.668739204230945, -112.14311599731445],
            [37.66833156378343, -112.13865280151367],
            [37.66289614387081, -112.13916778564453],
            [37.66303203421964, -112.1480941772461],
            [37.65569359940679, -112.1480941772461],
            [37.655557695625056, -112.1652603149414],
            [37.65216002023906, -112.16543197631835],
            [37.65161637775018, -112.17487335205078],
            [37.64454866323648, -112.17470169067383],
            [37.64441273905835, -112.18414306640625],
            [37.622933594900864, -112.18414306640625],
            [37.622797631179594, -112.18311309814453],
            [37.61667900634856, -112.18328475952148],
            [37.61640705577992, -112.20148086547852],
            [37.61287160787662, -112.20130920410155],
            [37.61300758975032, -112.21040725708008],
            [37.602128254141654, -112.21057891845703],
            [37.6019922523768, -112.2195053100586],
            [37.594783803063656, -112.21967697143553],
            [37.594783803063656, -112.2286033630371],
            [37.587710683522225, -112.22843170166016],
            [37.587438627038566, -112.23306655883789],
            [37.5806368917829, -112.23323822021484],
            [37.580228767905275, -112.23787307739258],
            [37.57315426523527, -112.23787307739258],
            [37.57329031970199, -112.24233627319336],
            [37.56580695492944, -112.24233627319336],
            [37.56567088679239, -112.24679946899414],
            [37.55845891987078, -112.24697113037108],
            [37.558322838312826, -112.25109100341797],
            [37.55138234931889, -112.25160598754881],
            [37.55138234931889, -112.2557258605957],
            [37.543624567295424, -112.25641250610352],
            [37.54416899939234, -112.27306365966797],
          ];
        }
        if (parkName.value === "Zion National Park") {
          newPark.outline = [
            [37.33631625612842, -113.10836791992188],
            [37.257112607698105, -113.10905456542969],
            [37.2576591253159, -113.11798095703125],
            [37.23470197166817, -113.11798095703125],
            [37.235248651837395, -113.10836791992188],
            [37.1986123165983, -113.1097412109375],
            [37.199159258361455, -113.09120178222656],
            [37.171807316143166, -113.08982849121092],
            [37.17235445206048, -113.01704406738281],
            [37.17782559332976, -113.01773071289062],
            [37.17891977403989, -113.0115509033203],
            [37.18493748465265, -113.01292419433594],
            [37.183296338395685, -113.00743103027344],
            [37.201893907733826, -113.00605773925781],
            [37.201893907733826, -112.9888916015625],
            [37.18384339111027, -112.98614501953125],
            [37.18384339111027, -112.99781799316406],
            [37.17071303242321, -112.99781799316406],
            [37.170165884620566, -113.01086425781249],
            [37.16195819218457, -113.01017761230469],
            [37.16414699732166, -112.96897888183594],
            [37.14116138236253, -112.96897888183594],
            [37.14170874010794, -112.9010009765625],
            [37.15156050223665, -112.89894104003906],
            [37.15265506325517, -112.86186218261719],
            [37.25055408701377, -112.86529541015625],
            [37.25383341872526, -112.884521484375],
            [37.26640286793118, -112.88246154785156],
            [37.267495764381856, -112.90237426757811],
            [37.28279464911045, -112.9010009765625],
            [37.370702880453074, -112.9016876220703],
            [37.37561396938701, -113.00331115722655],
            [37.391981943533544, -113.00056457519531],
            [37.39907362268733, -113.01292419433594],
            [37.397437140899775, -113.03764343261719],
            [37.384344000228964, -113.04656982421875],
            [37.37233994582318, -113.05824279785155],
            [37.37288562634096, -113.09600830078125],
            [37.44488060256697, -113.09463500976562],
            [37.44488060256697, -113.14682006835938],
            [37.50264464701539, -113.148193359375],
            [37.50318937824072, -113.19969177246094],
            [37.47867253877263, -113.19900512695311],
            [37.47812762872122, -113.20724487304688],
            [37.46504859550001, -113.2086181640625],
            [37.46559360090852, -113.22853088378906],
            [37.44978683111484, -113.22853088378906],
            [37.44978683111484, -113.21685791015625],
            [37.400710068740565, -113.21617126464844],
            [37.40016459069333, -113.20381164550781],
            [37.388708634542056, -113.20724487304688],
            [37.38707192644979, -113.19694519042969],
            [37.37233994582318, -113.19557189941406],
            [37.37397697546802, -113.12416076660156],
            [37.35269280367274, -113.12690734863281],
            [37.351601144954785, -113.11798095703125],
            [37.33631625612842, -113.11660766601562],
            [37.33696456235654, -113.1086254119873],
            [37.3356338224747, -113.1082820892334],
          ];
        }
        db.park.create(newPark).then((x) => {
          // console.log(x);
        });
      }
    }
  });

  const arches = {
    name: "Arches National Park",
    type: "PARK",
    state: "UT",
    latitude: 38.70791763,
    longitude: -109.595456,
  };

  const bryce = {
    name: "Bryce Canyon National Park",
    type: "PARK",
    state: "UT",
    latitude: 37.58399144,
    longitude: -112.1826689,
  };

  const zion = {
    name: "Zion National Park",
    type: "PARK",
    state: "AZ",
    latitude: 37.318099,
    longitude: -113.029996,
  };
  // db.park.create(bryce);
  // db.park.create(arches);
  // db.park.create(zion);

  // const newUser = {
  //   id: 1,
  //   userName: "shicks255",
  // };
  // db.user.create(newUser);

  // const userVisit = {
  //   userId: 1,
  //   parkId: 1,
  //   visited: "10/3/2021",
  //   comment: "Good Times",
  //   rating: 4.0,
  // };
  // db.user_visit.create(userVisit);
});

app.get("/api/hello", (req, res) => {
  res.json({ message: "Hello from the server" });
  logger.info("Server processed a hello message", { latency: 2500 });
});

app.get("/api/parks", (req, res) => {
  const start = new Date().getTime();
  logger.info("Request", { path: "/api/parks", method: "GET", stage: "start" });
  db.park.findAll({}).then((data) => {
    res.json(data);
    const latency = new Date().getTime() - start;
    logger.info("Response", {
      path: "/api/parks",
      method: "GET",
      stage: "end",
      latency: latency,
      result: data.slice(0, 3),
    });
  });
});

app.get("/api/parks/:parkId", (req, res) => {
  const { parkId } = req.params;
});

app.get("/api/parkDetails/:parkId", (req, res) => {
  const { parkId } = req.params;
  const start = new Date().getTime();
  logger.info("Request", {
    path: "/api/parks",
    args: { parkId: "`${parkId}`" },
    stage: "start",
  });
  const npsUrl = `https://developer.nps.gov/api/v1/parks?parkCode=${parkId}&api_key=${API_TOKEN}`;
  fetch(npsUrl).then((res) => {
    res.json().then((re) => {
      console.log(re);
    });
  });
});

app.get("/api/userVisit/:userId", (req, res) => {
  const { userId } = req.params;
  const start = new Date().getTime();
  logger.info("Request", {
    path: "/api/userVisits",
    method: "GET",
    args: { userId: `"${userId}"` },
    stage: "start",
  });

  db.user_visit.findAll({ userId: userId }).then((data) => {
    res.json(data);
    const latency = new Date().getTime() - start;
    logger.info("Response", {
      path: "/api/userVisit",
      method: "GET",
      stage: "end",
      latency: latency,
      result: data.slice(0, 3),
    });
  });
});

app.post("/api/userVisit", (req, res) => {
  // const { userId } = req.params;
  const userVisit = req.body;
  const sanitizedVisit = {
    ...userVisit,
    rating: parseInt(userVisit.rating),
  };

  const start = new Date().getTime();
  logger.info("Request", {
    path: "/api/userVisits",
    method: "GET",
    args: { userId: `"${userId}"` },
    stage: "start",
  });

  db.user_visit.create(sanitizedVisit).then((result) => {
    console.log(result);

    const latency = new Date().getTime() - start;
    logger.info("Response", {
      path: "/api/userVisit",
      method: "GET",
      stage: "end",
      latency: latency,
      result: data.slice(0, 3),
    });
  });

  // console.log(userId);
  console.log(userVisit);
});

app.get("/api/user/:userId", (req, res) => {
  const { userId } = req.params;
});

app.listen(PORT, () => {
  console.log(`Server listening on ${PORT}`);
  logger.info(`Server started listening on port ${PORT}`);
});
